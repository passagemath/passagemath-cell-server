#!/usr/bin/env bash

# spkg-install for SageCell, generated by SageCell's spkg-dist

if [[ -z "$SAGE_LOCAL" ]]; then
   echo "SAGE_LOCAL undefined ... exiting"
   echo "Maybe run 'sage --sh'?"
   exit 1
fi

cd src

SRC="`pwd`"

# make sure the new sagenb is installed somehow...

echo "Installing zeromq"
cd zeromq
./configure --prefix="$SAGE_LOCAL"
if [ $? -ne 0 ]; then
    echo >&2 "Error configuring zeromq."
    exit 1
fi

$MAKE
if [ $? -ne 0 ]; then
   echo "Error building zeromq."
   exit 1
fi

$MAKE install
if [ $? -ne 0 ]; then
   echo "Error installing zeromq."
   exit 1
fi

echo "Installing python dependencies"
cd $SRC
%(install_python_dependencies)s

echo "Patching Sage"
cd $SAGE_ROOT/devel/sage/
hg qimport $SRC/sagecell/sage-patches/01-sage-embedded.patch
hg qpush
hg qimport $SRC/sagecell/sage-patches/02-sage-show.patch
hg qpush
$SAGE_ROOT/sage -b

cd $SRC

if [ -d "$SAGE_ROOT/devel/sagecell-main" ]; then
    echo "Moving old SageCell package to '$SAGE_ROOT/devel/sagecell-main-old'..."
    rm -rf "$SAGE_ROOT/devel/sagecell-main-old"
    mv "$SAGE_ROOT/devel/sagecell-main" "$SAGE_ROOT/devel/sagecell-main-old"
    if [ $? -ne 0 ]; then
        echo >&2 "Error moving the old 'sagecell-main'."
        exit 1
    fi
fi

rm -f "$SAGE_ROOT/devel/sagecell" # Delete just the link itself (if it exists)

# We need to have -R below so symbolic links are copied correctly
cp -pR sagecell "$SAGE_ROOT/devel/sagecell-main" # Creates new sagecell-main dir
if [ $? -ne 0 ]; then
    echo >&2 "Error copying the new SageCell package."
    exit 1
fi

cd "$SAGE_ROOT/devel"
ln -s sagecell-main sagecell # Create new symbolic link (deleted above)
if [ $? -ne 0 ]; then
    echo >&2 "Error creating symbolic link to '$SAGE_ROOT/devel/sagecell-main'."
    exit 1
fi

SAGECELL="$SAGE_ROOT/devel/sagecell"

cd "$SAGECELL/static"
ln -s "$SAGE_ROOT/local/share/jmol" .
if [ $? -ne 0 ]; then
    echo >&2 "Error making jmol symbolic link."
    exit 1
fi

cd "$SRC"
cp -pr mathjax/ "$SAGECELL/static/mathjax/" # Creates mathjax directory
if [ $? -ne 0 ]; then
    echo >&2 "Error copying Mathjax."
    exit 1
fi


cd "$SAGECELL/static"
make
if [ $? -ne 0 ]; then
    echo >&2 "Error minifying javascript and CSS."
    exit 1
fi

